# BinaryView and Utf8View Integration Tests

Cross-implementation compatibility tests demonstrating that arrow-js can read BinaryView and Utf8View data generated by PyArrow.

## Testing Methodology

### Generation Phase (PyArrow → Arrow IPC files)

1. **`generate_test_data.py` runs using PyArrow**
   - Creates test data with BinaryView and Utf8View types
   - Includes various sizes: empty, small (≤12 bytes inline), large (>12 bytes out-of-line)
   - **Writes Arrow IPC format files** - the standard Arrow binary format that all Arrow implementations must be able to read/write
   - Files contain:
     - Schema metadata (column names, types)
     - View structs (16-byte format: size + inline data OR buffer reference)
     - Variadic buffers (for data >12 bytes)

### Validation Phase (Arrow IPC files → arrow-js)

2. **`validate_test_data.js` runs using arrow-js**
   - **Opens the PyArrow-generated IPC files** using arrow-js's `tableFromIPC()` function
   - Reads the schema to verify arrow-js recognizes BinaryView/Utf8View types
   - **Iterates through every row and extracts values** using arrow-js's `.get(i)` method
   - Validates arrow-js correctly:
     - Reads the 16-byte view structs
     - Decodes inline data (≤12 bytes) from view structs
     - Follows buffer references to variadic buffers for out-of-line data (>12 bytes)
     - Handles null and empty values
     - Decodes UTF-8 strings properly
   - **Fails the test if any decode errors occur**

## Why This Validates Cross-Implementation Compatibility

Arrow IPC format is the universal interchange format that all Arrow implementations must support.

- **PyArrow writes** BinaryView/Utf8View data → IPC file
- **arrow-js reads** that exact same IPC file and extracts correct values
- **This proves:** arrow-js implements the BinaryView/Utf8View specification correctly

If arrow-js couldn't read PyArrow's files, it would mean arrow-js doesn't correctly implement the specification. Successful validation proves arrow-js is specification-compliant and interoperable with other Arrow implementations.

## Test Coverage

The integration tests validate:

- ✅ **BinaryView type support** - Reading binary data using view format
- ✅ **Utf8View type support** - Reading UTF-8 strings using view format
- ✅ **Inline data handling** - Values ≤12 bytes stored inline in view structs
- ✅ **Out-of-line data handling** - Values >12 bytes stored in variadic buffers
- ✅ **Null value handling** - Proper handling of null entries
- ✅ **Empty value handling** - Proper handling of zero-length values
- ✅ **Boundary conditions** - Values at exactly 12 bytes (inline/out-of-line boundary)
- ✅ **Unicode support** - UTF-8 strings including emoji and multi-byte characters
- ✅ **Mixed columns** - Tables with both BinaryView and Utf8View columns

## Files

- **`generate_test_data.py`** - Python script using PyArrow to generate test data
- **`validate_test_data.js`** - Node.js script using arrow-js to validate the data
- **`test_results.txt`** - Captured output from validation run
- **`*.arrow`** - Arrow IPC files containing test data:
  - `binaryview_test.arrow` - BinaryView column (8 rows)
  - `utf8view_test.arrow` - Utf8View column (8 rows)
  - `combined_test.arrow` - Both column types (4 rows)

## Running the Tests

### Prerequisites

**For generating test data (Python):**
```bash
python3 -m venv integration_tests/venv
source integration_tests/venv/bin/activate  # macOS/Linux
pip install pyarrow
```

**For validating test data (Node.js):**
```bash
yarn build -t es2015 -m cjs
```

### Generate test data with PyArrow:
```bash
integration_tests/venv/bin/python integration_tests/binaryview_utf8view/generate_test_data.py
```

### Validate with arrow-js:
```bash
node integration_tests/binaryview_utf8view/validate_test_data.js
```

## Results

All integration tests pass successfully:

```
============================================================
✓ All integration tests passed!

This demonstrates that arrow-js can successfully read
BinaryView and Utf8View data generated by PyArrow,
proving cross-implementation compatibility.
============================================================
```

This proves **full cross-implementation compatibility** between arrow-js and other Arrow implementations for BinaryView and Utf8View types.

## Next Steps

After this PR is merged, submit a PR to `apache/arrow` to remove `.skip_tester('JS')` for BinaryView/Utf8View tests in the Archery integration test suite.
